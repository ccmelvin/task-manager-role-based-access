name: Validate IAM Policies and Deploy

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.9'

jobs:
  validate-structure:
    runs-on: ubuntu-latest
    name: Validate Project Structure
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Validate Infrastructure Files
      run: |
        echo "ğŸ¯ Validating infrastructure directory structure..."
        echo ""
        
        # Check if infrastructure directory exists
        if [ ! -d "infrastructure" ]; then
          echo "âŒ ERROR: infrastructure directory not found"
          exit 1
        fi
        echo "âœ… Infrastructure directory exists"
        
        # Check for key infrastructure files
        echo ""
        echo "ğŸ“ Infrastructure files:"
        ls -la infrastructure/
        echo ""
        
        # Check for IAM policy validator tools
        if [ -f "infrastructure/iam_policy_validator.py" ]; then
          echo "âœ… GUI IAM Policy Validator found"
        else
          echo "âš ï¸  GUI IAM Policy Validator not found"
        fi
        
        if [ -f "infrastructure/simple_validator.py" ]; then
          echo "âœ… CLI IAM Policy Validator found"
        else
          echo "âš ï¸  CLI IAM Policy Validator not found"
        fi
        
        if [ -f "infrastructure/iam_policy_validator_cli.py" ]; then
          echo "âœ… Advanced CLI IAM Policy Validator found"
        else
          echo "âš ï¸  Advanced CLI IAM Policy Validator not found"
        fi
        
        # Check for CDK files
        if [ -f "infrastructure/cdk.json" ]; then
          echo "âœ… CDK configuration found"
        else
          echo "âš ï¸  CDK configuration not found"
        fi
        
        if [ -f "infrastructure/package.json" ]; then
          echo "âœ… Infrastructure package.json found"
        else
          echo "âš ï¸  Infrastructure package.json not found"
        fi
        
        echo ""
        echo "ğŸ‰ Structure validation completed!"

  validate-syntax:
    runs-on: ubuntu-latest
    name: Validate File Syntax
    needs: validate-structure
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ” Validate Python Syntax
      run: |
        echo "ğŸ Validating Python file syntax..."
        echo ""
        
        # Check Python files in infrastructure directory
        python_files=$(find infrastructure -name "*.py" -type f)
        
        if [ -z "$python_files" ]; then
          echo "âš ï¸  No Python files found in infrastructure directory"
        else
          echo "ğŸ“ Found Python files:"
          echo "$python_files"
          echo ""
          
          # Validate syntax of each Python file
          for file in $python_files; do
            echo "Checking: $file"
            if python -m py_compile "$file"; then
              echo "âœ… $file - syntax OK"
            else
              echo "âŒ $file - syntax ERROR"
              exit 1
            fi
          done
        fi
        
        echo ""
        echo "ğŸ‰ Python syntax validation completed!"

  validate-json:
    runs-on: ubuntu-latest
    name: Validate JSON Files
    needs: validate-structure
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Validate JSON Syntax
      run: |
        echo "ğŸ“„ Validating JSON file syntax..."
        echo ""
        
        # Check JSON files in infrastructure directory
        json_files=$(find infrastructure -name "*.json" -type f)
        
        if [ -z "$json_files" ]; then
          echo "âš ï¸  No JSON files found in infrastructure directory"
        else
          echo "ğŸ“ Found JSON files:"
          echo "$json_files"
          echo ""
          
          # Validate syntax of each JSON file
          for file in $json_files; do
            echo "Checking: $file"
            if python -m json.tool "$file" > /dev/null; then
              echo "âœ… $file - syntax OK"
            else
              echo "âŒ $file - syntax ERROR"
              exit 1
            fi
          done
        fi
        
        echo ""
        echo "ğŸ‰ JSON syntax validation completed!"

  # Deployment job - disabled until AWS credentials are configured
  # deploy:
  #   needs: [validate-structure, validate-syntax, validate-json]
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  #   name: Deploy to AWS (Disabled - Configure AWS Secrets)
  #   
  #   steps:
  #   - name: âš ï¸ Deployment Disabled
  #     run: |
  #       echo "ğŸš« Deployment is currently disabled"
  #       echo ""
  #       echo "To enable deployment, configure these GitHub secrets:"
  #       echo "- AWS_ACCESS_KEY_ID"
  #       echo "- AWS_SECRET_ACCESS_KEY"
  #       echo ""
  #       echo "Then uncomment the deployment job in this workflow file."
