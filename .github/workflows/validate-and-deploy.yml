name: Validate IAM Policies and Deploy

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.9'

jobs:
  validate-structure:
    runs-on: ubuntu-latest
    name: Validate Project Structure
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
    
    - name: 🔍 Validate Infrastructure Files
      run: |
        echo "🎯 Validating infrastructure directory structure..."
        echo ""
        
        # Check if infrastructure directory exists
        if [ ! -d "infrastructure" ]; then
          echo "❌ ERROR: infrastructure directory not found"
          exit 1
        fi
        echo "✅ Infrastructure directory exists"
        
        # Check for key infrastructure files
        echo ""
        echo "📁 Infrastructure files:"
        ls -la infrastructure/
        echo ""
        
        # Check for IAM policy validator tools
        if [ -f "infrastructure/iam_policy_validator.py" ]; then
          echo "✅ GUI IAM Policy Validator found"
        else
          echo "⚠️  GUI IAM Policy Validator not found"
        fi
        
        if [ -f "infrastructure/simple_validator.py" ]; then
          echo "✅ CLI IAM Policy Validator found"
        else
          echo "⚠️  CLI IAM Policy Validator not found"
        fi
        
        if [ -f "infrastructure/iam_policy_validator_cli.py" ]; then
          echo "✅ Advanced CLI IAM Policy Validator found"
        else
          echo "⚠️  Advanced CLI IAM Policy Validator not found"
        fi
        
        # Check for CDK files
        if [ -f "infrastructure/cdk.json" ]; then
          echo "✅ CDK configuration found"
        else
          echo "⚠️  CDK configuration not found"
        fi
        
        if [ -f "infrastructure/package.json" ]; then
          echo "✅ Infrastructure package.json found"
        else
          echo "⚠️  Infrastructure package.json not found"
        fi
        
        echo ""
        echo "🎉 Structure validation completed!"

  validate-syntax:
    runs-on: ubuntu-latest
    name: Validate File Syntax
    needs: validate-structure
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
    
    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: 🔍 Validate Python Syntax
      run: |
        echo "🐍 Validating Python file syntax..."
        echo ""
        
        # Check Python files in infrastructure directory
        python_files=$(find infrastructure -name "*.py" -type f)
        
        if [ -z "$python_files" ]; then
          echo "⚠️  No Python files found in infrastructure directory"
        else
          echo "📁 Found Python files:"
          echo "$python_files"
          echo ""
          
          # Validate syntax of each Python file
          for file in $python_files; do
            echo "Checking: $file"
            if python -m py_compile "$file"; then
              echo "✅ $file - syntax OK"
            else
              echo "❌ $file - syntax ERROR"
              exit 1
            fi
          done
        fi
        
        echo ""
        echo "🎉 Python syntax validation completed!"

  validate-json:
    runs-on: ubuntu-latest
    name: Validate JSON Files
    needs: validate-structure
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
    
    - name: 🔍 Validate JSON Syntax
      run: |
        echo "📄 Validating JSON file syntax..."
        echo ""
        
        # Check JSON files in infrastructure directory
        json_files=$(find infrastructure -name "*.json" -type f)
        
        if [ -z "$json_files" ]; then
          echo "⚠️  No JSON files found in infrastructure directory"
        else
          echo "📁 Found JSON files:"
          echo "$json_files"
          echo ""
          
          # Validate syntax of each JSON file
          for file in $json_files; do
            echo "Checking: $file"
            if python -m json.tool "$file" > /dev/null; then
              echo "✅ $file - syntax OK"
            else
              echo "❌ $file - syntax ERROR"
              exit 1
            fi
          done
        fi
        
        echo ""
        echo "🎉 JSON syntax validation completed!"

  # Deployment job - disabled until AWS credentials are configured
  # deploy:
  #   needs: [validate-structure, validate-syntax, validate-json]
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  #   name: Deploy to AWS (Disabled - Configure AWS Secrets)
  #   
  #   steps:
  #   - name: ⚠️ Deployment Disabled
  #     run: |
  #       echo "🚫 Deployment is currently disabled"
  #       echo ""
  #       echo "To enable deployment, configure these GitHub secrets:"
  #       echo "- AWS_ACCESS_KEY_ID"
  #       echo "- AWS_SECRET_ACCESS_KEY"
  #       echo ""
  #       echo "Then uncomment the deployment job in this workflow file."
